generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===================
// Tenant & Auth
// ===================

model Tenant {
  id            String   @id @default(uuid()) @db.Uuid
  name          String   @db.VarChar(255)
  subdomain     String   @unique @db.VarChar(63)
  settings      Json     @default("{}")
  status        String   @default("active") @db.VarChar(20)
  maxUsers      Int?     @map("max_users")
  storageLimitGb Int?    @map("storage_limit_gb")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime @updatedAt @map("updated_at") @db.Timestamptz

  users            User[]
  organizations    Organization[]
  roles            Role[]
  evaluationCycles EvaluationCycle[]
  courses          Course[]
  skills           Skill[]
  skillCategories  SkillCategory[]

  @@map("tenants")
}

model Organization {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  parentId  String?  @map("parent_id") @db.Uuid
  name      String   @db.VarChar(255)
  code      String   @db.VarChar(50)
  level     Int      @default(0)
  path      String   @db.VarChar(500)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz

  tenant   Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  parent   Organization? @relation("OrganizationHierarchy", fields: [parentId], references: [id])
  children Organization[] @relation("OrganizationHierarchy")
  users    User[]

  @@unique([tenantId, code])
  @@map("organizations")
}

model User {
  id             String    @id @default(uuid()) @db.Uuid
  tenantId       String    @map("tenant_id") @db.Uuid
  organizationId String?   @map("organization_id") @db.Uuid
  email          String    @db.VarChar(255)
  passwordHash   String    @map("password_hash") @db.VarChar(255)
  firstName      String    @map("first_name") @db.VarChar(100)
  lastName       String    @map("last_name") @db.VarChar(100)
  employeeId     String?   @map("employee_id") @db.VarChar(50)
  position       String?   @db.VarChar(100)
  jobTitle       String?   @map("job_title") @db.VarChar(100)
  hireDate       DateTime? @map("hire_date") @db.Date
  managerId      String?   @map("manager_id") @db.Uuid
  mfaEnabled     Boolean   @default(false) @map("mfa_enabled")
  mfaSecret      String?   @map("mfa_secret") @db.VarChar(255)
  status         String    @default("active") @db.VarChar(20)
  lastLoginAt    DateTime? @map("last_login_at") @db.Timestamptz
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt      DateTime? @map("deleted_at") @db.Timestamptz

  tenant       Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  organization Organization? @relation(fields: [organizationId], references: [id])
  manager      User?         @relation("ManagerRelation", fields: [managerId], references: [id])
  subordinates User[]        @relation("ManagerRelation")

  userRoles         UserRole[]
  goals             Goal[]
  evaluationsGiven  Evaluation[]      @relation("EvaluatorRelation")
  evaluationsReceived Evaluation[]    @relation("EvaluateeRelation")
  enrollments       CourseEnrollment[]
  userSkills        UserSkill[]
  refreshTokens     RefreshToken[]

  @@unique([tenantId, email])
  @@index([tenantId, organizationId])
  @@index([tenantId, managerId])
  @@map("users")
}

model Role {
  id          String   @id @default(uuid()) @db.Uuid
  tenantId    String   @map("tenant_id") @db.Uuid
  name        String   @db.VarChar(100)
  description String?  @db.Text
  permissions Json     @default("[]")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz

  tenant    Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  userRoles UserRole[]

  @@unique([tenantId, name])
  @@map("roles")
}

model UserRole {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  roleId    String   @map("role_id") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@map("user_roles")
}

model RefreshToken {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  token     String   @unique @db.VarChar(500)
  expiresAt DateTime @map("expires_at") @db.Timestamptz
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("refresh_tokens")
}

// ===================
// Evaluation System
// ===================

model EvaluationCycle {
  id                  String   @id @default(uuid()) @db.Uuid
  tenantId            String   @map("tenant_id") @db.Uuid
  name                String   @db.VarChar(255)
  startDate           DateTime @map("start_date") @db.Date
  endDate             DateTime @map("end_date") @db.Date
  evaluationStartDate DateTime @map("evaluation_start_date") @db.Date
  evaluationEndDate   DateTime @map("evaluation_end_date") @db.Date
  status              String   @default("draft") @db.VarChar(20)
  settings            Json     @default("{}")
  createdAt           DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt           DateTime @updatedAt @map("updated_at") @db.Timestamptz

  tenant      Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  goals       Goal[]
  evaluations Evaluation[]

  @@index([tenantId, status])
  @@map("evaluation_cycles")
}

model Goal {
  id               String    @id @default(uuid()) @db.Uuid
  tenantId         String    @map("tenant_id") @db.Uuid
  userId           String    @map("user_id") @db.Uuid
  cycleId          String    @map("cycle_id") @db.Uuid
  parentGoalId     String?   @map("parent_goal_id") @db.Uuid
  title            String    @db.VarChar(255)
  description      String?   @db.Text
  successCriteria  String?   @map("success_criteria") @db.Text
  weight           Int       @default(0)
  status           String    @default("draft") @db.VarChar(20)
  approvedBy       String?   @map("approved_by") @db.Uuid
  approvedAt       DateTime? @map("approved_at") @db.Timestamptz
  finalAchievement Int?      @map("final_achievement")
  createdAt        DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt        DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  user       User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  cycle      EvaluationCycle  @relation(fields: [cycleId], references: [id], onDelete: Cascade)
  parentGoal Goal?            @relation("GoalHierarchy", fields: [parentGoalId], references: [id])
  childGoals Goal[]           @relation("GoalHierarchy")
  progress   GoalProgress[]

  @@index([tenantId, userId, cycleId])
  @@index([tenantId, status])
  @@map("goals")
}

model GoalProgress {
  id                 String   @id @default(uuid()) @db.Uuid
  goalId             String   @map("goal_id") @db.Uuid
  progressPercentage Int      @map("progress_percentage")
  comment            String?  @db.Text
  updatedBy          String   @map("updated_by") @db.Uuid
  createdAt          DateTime @default(now()) @map("created_at") @db.Timestamptz

  goal Goal @relation(fields: [goalId], references: [id], onDelete: Cascade)

  @@index([goalId])
  @@map("goal_progress")
}

model Evaluation {
  id             String    @id @default(uuid()) @db.Uuid
  tenantId       String    @map("tenant_id") @db.Uuid
  cycleId        String    @map("cycle_id") @db.Uuid
  evaluateeId    String    @map("evaluatee_id") @db.Uuid
  evaluatorId    String    @map("evaluator_id") @db.Uuid
  evaluationType String    @map("evaluation_type") @db.VarChar(50)
  status         String    @default("pending") @db.VarChar(20)
  overallComment String?   @map("overall_comment") @db.Text
  finalScore     Decimal?  @map("final_score") @db.Decimal(5, 2)
  submittedAt    DateTime? @map("submitted_at") @db.Timestamptz
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  cycle     EvaluationCycle   @relation(fields: [cycleId], references: [id], onDelete: Cascade)
  evaluatee User              @relation("EvaluateeRelation", fields: [evaluateeId], references: [id], onDelete: Cascade)
  evaluator User              @relation("EvaluatorRelation", fields: [evaluatorId], references: [id], onDelete: Cascade)
  scores    EvaluationScore[]

  @@index([tenantId, cycleId, evaluateeId])
  @@index([tenantId, evaluatorId, status])
  @@map("evaluations")
}

model EvaluationScore {
  id           String   @id @default(uuid()) @db.Uuid
  evaluationId String   @map("evaluation_id") @db.Uuid
  goalId       String   @map("goal_id") @db.Uuid
  score        Decimal  @db.Decimal(3, 1)
  achievement  Int?
  comment      String?  @db.Text
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt    DateTime @updatedAt @map("updated_at") @db.Timestamptz

  evaluation Evaluation @relation(fields: [evaluationId], references: [id], onDelete: Cascade)

  @@unique([evaluationId, goalId])
  @@map("evaluation_scores")
}

// ===================
// LMS (Learning Management System)
// ===================

model Course {
  id                String    @id @default(uuid()) @db.Uuid
  tenantId          String    @map("tenant_id") @db.Uuid
  title             String    @db.VarChar(255)
  description       String?   @db.Text
  category          String?   @db.VarChar(100)
  difficulty        String?   @db.VarChar(20)
  estimatedDuration Int?      @map("estimated_duration")
  thumbnailUrl      String?   @map("thumbnail_url") @db.VarChar(500)
  isPublished       Boolean   @default(false) @map("is_published")
  publishedAt       DateTime? @map("published_at") @db.Timestamptz
  tags              String[]  @default([])
  createdBy         String?   @map("created_by") @db.Uuid
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  tenant       Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  lessons      Lesson[]
  enrollments  CourseEnrollment[]
  courseSkills CourseSkill[]
  tests        Test[]

  @@index([tenantId, isPublished])
  @@index([tenantId, category])
  @@map("courses")
}

model Lesson {
  id          String   @id @default(uuid()) @db.Uuid
  courseId    String   @map("course_id") @db.Uuid
  title       String   @db.VarChar(255)
  description String?  @db.Text
  sortOrder   Int      @map("sort_order")
  duration    Int?
  isMandatory Boolean  @default(true) @map("is_mandatory")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz

  course   Course           @relation(fields: [courseId], references: [id], onDelete: Cascade)
  contents Content[]
  progress LessonProgress[]

  @@index([courseId, sortOrder])
  @@map("lessons")
}

model Content {
  id          String   @id @default(uuid()) @db.Uuid
  lessonId    String   @map("lesson_id") @db.Uuid
  contentType String   @map("content_type") @db.VarChar(50)
  title       String   @db.VarChar(255)
  url         String?  @db.VarChar(500)
  metadata    Json     @default("{}")
  sortOrder   Int      @map("sort_order")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz

  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@index([lessonId, sortOrder])
  @@map("contents")
}

model CourseEnrollment {
  id                 String    @id @default(uuid()) @db.Uuid
  tenantId           String    @map("tenant_id") @db.Uuid
  userId             String    @map("user_id") @db.Uuid
  courseId           String    @map("course_id") @db.Uuid
  status             String    @default("enrolled") @db.VarChar(20)
  progressPercentage Int       @default(0) @map("progress_percentage")
  enrolledAt         DateTime  @default(now()) @map("enrolled_at") @db.Timestamptz
  startedAt          DateTime? @map("started_at") @db.Timestamptz
  completedAt        DateTime? @map("completed_at") @db.Timestamptz
  deadline           DateTime? @db.Timestamptz
  assignedBy         String?   @map("assigned_by") @db.Uuid
  totalTimeSpent     Int       @default(0) @map("total_time_spent")
  createdAt          DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt          DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  user           User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  course         Course           @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessonProgress LessonProgress[]
  testAttempts   TestAttempt[]

  @@unique([userId, courseId])
  @@index([tenantId, userId, status])
  @@map("course_enrollments")
}

model LessonProgress {
  id                 String    @id @default(uuid()) @db.Uuid
  enrollmentId       String    @map("enrollment_id") @db.Uuid
  lessonId           String    @map("lesson_id") @db.Uuid
  status             String    @default("not_started") @db.VarChar(20)
  progressPercentage Int       @default(0) @map("progress_percentage")
  timeSpent          Int       @default(0) @map("time_spent")
  lastPosition       Int?      @map("last_position")
  lastAccessedAt     DateTime? @map("last_accessed_at") @db.Timestamptz
  completedAt        DateTime? @map("completed_at") @db.Timestamptz
  createdAt          DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt          DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  enrollment CourseEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  lesson     Lesson           @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([enrollmentId, lessonId])
  @@map("lesson_progress")
}

// ===================
// Tests & Assessments
// ===================

model Test {
  id               String   @id @default(uuid()) @db.Uuid
  tenantId         String   @map("tenant_id") @db.Uuid
  courseId         String   @map("course_id") @db.Uuid
  title            String   @db.VarChar(255)
  description      String?  @db.Text
  timeLimit        Int?     @map("time_limit")
  passingScore     Int      @default(70) @map("passing_score")
  maxAttempts      Int      @default(3) @map("max_attempts")
  shuffleQuestions Boolean  @default(false) @map("shuffle_questions")
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt        DateTime @updatedAt @map("updated_at") @db.Timestamptz

  course    Course         @relation(fields: [courseId], references: [id], onDelete: Cascade)
  questions TestQuestion[]
  attempts  TestAttempt[]

  @@map("tests")
}

model TestQuestion {
  id            String   @id @default(uuid()) @db.Uuid
  testId        String   @map("test_id") @db.Uuid
  questionType  String   @map("question_type") @db.VarChar(50)
  questionText  String   @map("question_text") @db.Text
  options       Json     @default("[]")
  correctAnswer Json     @map("correct_answer")
  points        Int      @default(1)
  sortOrder     Int      @map("sort_order")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime @updatedAt @map("updated_at") @db.Timestamptz

  test    Test         @relation(fields: [testId], references: [id], onDelete: Cascade)
  answers TestAnswer[]

  @@index([testId, sortOrder])
  @@map("test_questions")
}

model TestAttempt {
  id            String    @id @default(uuid()) @db.Uuid
  enrollmentId  String    @map("enrollment_id") @db.Uuid
  testId        String    @map("test_id") @db.Uuid
  attemptNumber Int       @map("attempt_number")
  status        String    @default("in_progress") @db.VarChar(20)
  score         Int?
  totalPoints   Int?      @map("total_points")
  startedAt     DateTime  @default(now()) @map("started_at") @db.Timestamptz
  submittedAt   DateTime? @map("submitted_at") @db.Timestamptz
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz

  enrollment CourseEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  test       Test             @relation(fields: [testId], references: [id], onDelete: Cascade)
  answers    TestAnswer[]

  @@index([enrollmentId, testId])
  @@map("test_attempts")
}

model TestAnswer {
  id           String   @id @default(uuid()) @db.Uuid
  attemptId    String   @map("attempt_id") @db.Uuid
  questionId   String   @map("question_id") @db.Uuid
  answer       Json
  isCorrect    Boolean  @map("is_correct")
  pointsEarned Int      @map("points_earned")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz

  attempt  TestAttempt  @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  question TestQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([attemptId, questionId])
  @@map("test_answers")
}

// ===================
// Skills Management
// ===================

model SkillCategory {
  id          String   @id @default(uuid()) @db.Uuid
  tenantId    String   @map("tenant_id") @db.Uuid
  name        String   @db.VarChar(100)
  description String?  @db.Text
  sortOrder   Int      @default(0) @map("sort_order")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz

  tenant Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  skills Skill[]

  @@unique([tenantId, name])
  @@map("skill_categories")
}

model Skill {
  id          String   @id @default(uuid()) @db.Uuid
  tenantId    String   @map("tenant_id") @db.Uuid
  categoryId  String   @map("category_id") @db.Uuid
  name        String   @db.VarChar(100)
  description String?  @db.Text
  maxLevel    Int      @default(5) @map("max_level")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz

  tenant       Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  category     SkillCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  userSkills   UserSkill[]
  courseSkills CourseSkill[]

  @@unique([tenantId, name])
  @@map("skills")
}

model UserSkill {
  id           String    @id @default(uuid()) @db.Uuid
  userId       String    @map("user_id") @db.Uuid
  skillId      String    @map("skill_id") @db.Uuid
  currentLevel Int       @default(0) @map("current_level")
  targetLevel  Int?      @map("target_level")
  assessedAt   DateTime? @map("assessed_at") @db.Timestamptz
  assessedBy   String?   @map("assessed_by") @db.Uuid
  evidence     Json      @default("{}")
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt    DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  skill Skill @relation(fields: [skillId], references: [id], onDelete: Cascade)

  @@unique([userId, skillId])
  @@map("user_skills")
}

model CourseSkill {
  id            String   @id @default(uuid()) @db.Uuid
  courseId      String   @map("course_id") @db.Uuid
  skillId       String   @map("skill_id") @db.Uuid
  skillLevelGain Int     @default(1) @map("skill_level_gain")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz

  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  skill  Skill  @relation(fields: [skillId], references: [id], onDelete: Cascade)

  @@unique([courseId, skillId])
  @@map("course_skills")
}
